{% extends 'layouts/base.html' %}
{% load static i18n humanize custom_tags %}

{% block extracss %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/detail.css' %}"/>
    <style>
        .table th {
            padding: 5px 30px 0 30px;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.025);
        }

        table.dataTable.dtr-inline.collapsed > tbody > tr[role="row"] > td.dtr-control::before {
            content: '>';
        }

        table.dataTable.dtr-inline.collapsed > tbody > tr.parent > td.dtr-control::before {
            content: '-';
        }
    </style>
{% endblock %}

{% block custom_title %}
    <div class="col-sm-6">
        <div class="m-0 main-title">{{ object.get_status_display }}</div>
    </div>
{% endblock %}


{% block content %}

<div class="row mb-3">
    <div class="col-8">
        <div class="card h-100">
            <div class="card-body">
                <div class="row">
                    <div class="col-4">
                        <p class="text-sm">{% translate 'Total funding selected' %}:</p>
                    </div>
                    <div class="col-8">
                        <p class="text-sm">
                            <b class="d-block total-funding-display">{{ total_funding|intcomma }}</b>
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <p class="text-sm">{% translate '# Sub-projects' %}:</p>
                    </div>
                    <div class="col-8">
                        <p class="text-sm">
                            <b class="d-block total-subprojects-display">0</b>
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <p class="text-sm">{% translate '# Villages' %}:</p>
                    </div>
                    <div class="col-8">
                        <p class="text-sm">
                            <b class="d-block total-villages-display">0</b>
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <p class="text-sm">{% translate 'Project' %}:</p>
                    </div>
                    <div class="col-8">
                        <p class="text-sm">
                            <b class="d-block">{{ object.project.name }}</b>
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <p class="text-sm">{% translate 'Status' %}:</p>
                    </div>
                    <div class="col-8">
                        <p class="text-sm">
                            <b class="d-block">{{ object.get_status_display }}</b>
                        </p>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-12 mb-4">
                        <h6>{% translate 'Sectors' %} ({{ sectors|length }}):</h6>

                        {% for sector in sectors %}
                        <span class="badge badge-pill badge-info mr-1 mb-1"
                              style="font-size: 12px; padding: 10px;">{{ sector.name }}
                        </span>
                        {% endfor %}

                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-2">
                        <h6>{% translate 'Categories' %} ({{ categories|length }}):</h6>

                        {% for category in categories %}
                        <span class="badge badge-pill badge-info mr-1 mb-1"
                              style="font-size: 12px; padding: 10px;">{{ category.name }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-4">
        <div class="card h-100">
            <div class="card-body">
                <h6>
                    {% translate 'Summary' %}
                </h6>
                <div class="row">
                    <div class="col-8">
                        <p class="text-sm float-right">{% translate 'Total funding selected' %}:</p>
                    </div>
                    <div class="col-4">
                        <p class="text-sm">
                            <b class="d-block total-funding-display">{{ total_funding|intcomma }}</b>
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-8">
                        <p class="text-sm float-right">{% translate '# Subprojects' %}:</p>
                    </div>
                    <div class="col-4">
                        <p class="text-sm">
                            <b class="d-block total-subprojects-display">0</b>
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-8">
                        <p class="text-sm float-right">{% translate '# Villages' %}:</p>
                    </div>
                    <div class="col-4">
                        <p class="text-sm">
                            <b class="d-block total-villages-display">0</b>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row">
                    <h6>{% translate 'Investments in your package' %}</h6>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        {% for key, value in query_strings.items %}
                        <span class="badge badge-pill badge-info mr-1"
                              style="font-size: 12px; padding: 10px;">{{ key }}: {{ value }}
                            <button type="button" class="close align-middle" aria-label="Close" style="font-size: 1rem; margin-left: 4px;">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <table class="table datatable display" style="width: 100%;">
                    <thead>
                    <th>{% translate 'Name' %}</th>
                    <th>{% translate 'Subproject type' %}</th>
                    <th>{% translate 'Estimate cost' %}</th>
                    <th>{% translate 'Village' %}</th>
                    <th>{% translate 'Commune' %}</th>
                    <th>{% translate 'Prefecture' %}</th>
                    <th>{% translate 'Region' %}</th>
                    <th>{% translate 'Village priority' %}</th>
                    <th>{% translate 'Population priority' %}</th>
                    </thead>
                    <tbody>
                    {% for investment in object.funded_investments.all %}
                    <tr>
                        <td>{{ investment.title }}</td>
                        <td>{{ investment.administrative_level.type }}</td>
                        <td data-order="{{ investment.estimated_cost }}" data-search="{{ investment.estimated_cost }}">
                            {{ investment.estimated_cost|intcomma }}
                        </td>
                        <td>{{ investment.administrative_level.name }}</td>
                        <td>{{ investment.administrative_level.parent.name }}</td>
                        <td>{{ investment.administrative_level.parent.parent.name }}</td>
                        <td>{{ investment.administrative_level.parent.parent.parent.name }}</td>
                        <td>{{ investment.administrative_level.rank }}</td>
                        <td>
                            {% if investment.endorsed_by_youth %}
                            J,
                            {% endif %}
                            {% if investment.endorsed_by_women %}
                            F,
                            {% endif %}
                            {% if investment.endorsed_by_agriculturist %}
                            AG,
                            {% endif %}
                            {% if investment.endorsed_by_pastoralist %}
                            ME
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="{% static 'js/numeral.min.js' %}"></script>
<script type="text/javascript">
    $( document ).ready(function() {

        let table = $(".datatable").DataTable({{ datatable_config | safe }});

        sum_subprojects();

        table.on('click', 'tr', function(){
            sum_subprojects();
        });

        $('.column-switch').on('change', function (e) {

            // Get the column API object
            var column = table.column($(this).attr('data-column'));

            // Toggle the visibility
            column.visible(!column.visible());
        });

        function sum_subprojects() {
            let villages = [];
            let funding = 0;
            let subprojects = 0;

            table.rows().every( function ( rowIdx ) {
                let firstVal = $( this.node() ).first().val();

                console.log(firstVal);

                if (firstVal != undefined) {
                    let subproject_data = table.row( rowIdx ).data();
                    subprojects += 1;

                    $('#investments-input-id').val($('#investments-input-id').val() + ',' + firstVal);

                    funding = parseInt(funding) + parseInt(subproject_data[2]["@data-order"])

                    if (!villages.includes(subproject_data[3])) {
                        villages.push(subproject_data[3])
                    }
                }
            } );

            $('.total-villages-display').html(numeral(villages.length).format('0,0'));
            $('.total-subprojects-display').html(numeral(subprojects).format('0,0'));

        };
    });
</script>
{% endblock %}